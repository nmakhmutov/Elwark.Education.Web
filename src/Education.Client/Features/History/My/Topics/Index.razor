@page "/history/my/topics"
@layout HistoryLayout

@using Education.Client.Gateways.History
@using Education.Client.Gateways.History.Me
@using Education.Client.Extensions
@using Education.Client.Features.History.Components

@attribute [Authorize]

<PageTitle>@L["Test:MyProgress"]</PageTitle>
<MainContainer>
    <PageHeader Title="@L["Test:MyProgress"]" Class="mb-3 mb-sm-6" Breadcrumbs="@Breadcrumbs"/>

    <MudTable ServerData="@ServerReload" Dense="true" Hover="true" RowsPerPage="25">
        <HeaderContent>
            <MudTh/>
            <MudTh>@L["Title"]</MudTh>
            <MudTh>@L["NumberOfTests:TotalPassed"]</MudTh>
            <MudTh>@L["TimeSpent:Total"]</MudTh>
            <MudTh/>
            <MudTh/>
        </HeaderContent>
        <RowTemplate>
            <MudTd>
                <MudAvatar Image="@context.Image"/>
            </MudTd>
            <MudTd DataLabel="@L["Title"]">
                <MudLink Href="@Links.History.TopicById(context.Id)">
                    @context.Title
                </MudLink>
            </MudTd>
            <MudTd DataLabel="@L["NumberOfTests:TotalPassed"]">
                @context.Progress.PassedTests.ToReadable()
            </MudTd>
            <MudTd DataLabel="@L["TimeSpent:Total"]">
                @context.Progress.TimeSpent.ToLongFormat()
            </MudTd>
            <MudTd>
                <FavoriteToggleButton
                    IsFavorite="@context.IsFavorite"
                    TopicId="@context.Id"
                    OnFavoriteClick="@OnFavoriteClick"/>
            </MudTd>
            <MudTd>
                <MudTooltip Text="@L["Details"]">
                    <MudIconButton Link="@Links.History.MyTopic(context.Id)" Icon="@Icons.Material.Outlined.ReadMore"/>
                </MudTooltip>
            </MudTd>
        </RowTemplate>
        <NoRecordsContent>
            <MudText>No matching records found</MudText>
        </NoRecordsContent>
        <LoadingContent>
            <MudText>Loading...</MudText>
        </LoadingContent>
        <PagerContent>
            <MudTablePager/>
        </PagerContent>
    </MudTable>

    @* <EmptyResult *@
    @* Class="grid-full-row" *@
    @* Title="@L["Profile:EmptyFavoritesTitle"]" *@
    @* Subtitle="@L["Profile:EmptyFavoritesSubtitle"]"/> *@

</MainContainer>

@code {
    private TopicsProgressRequest _request = new(false, TopicsProgressRequest.SortType.DateAddedNewest, 1, 20);

    private List<BreadcrumbItem> Breadcrumbs => new()
    {
        new BreadcrumbItem(L["Account"].Value, Links.Account.Index),
        new BreadcrumbItem(L["Profile"].Value, Links.History.MyProfile)
    };

    [Inject]
    private IHistoryClient HistoryClient { get; set; } = default!;

    [Inject]
    private IStringLocalizer<App> L { get; set; } = default!;

    private async Task<TableData<UserTopicSummary>> ServerReload(TableState state)
    {
        _request = _request with {
            Page = state.Page + 1,
            Count = (short)state.PageSize
            };

        var data = await HistoryClient.Me.GetTopicsProgressAsync(_request);

        return new TableData<UserTopicSummary>
        {
            Items = data.Data.Items,
            TotalItems = (int)data.Data.Count
        };
    }

    private async Task<bool> OnFavoriteClick(string topicId)
    {
        var result = await HistoryClient.Topic.ToggleFavoriteAsync(topicId);
        return result.Status == ResponseStatus.Success && result.Data;
    }

}
