@page "/history/my/topics"
@layout HistoryLayout

@using Education.Client.Gateways.History
@using Education.Client.Gateways.History.Me
@using Education.Client.Features.History.Components

@attribute [Authorize]

<PageTitle>@L["Test:MyProgress"]</PageTitle>
<MainContainer>
    <PageHeader Title="@L["Test:MyProgress"]" Class="mb-3 mb-sm-6" Breadcrumbs="@Breadcrumbs"/>

    <MudTable ServerData="@ServerReload" Breakpoint="Breakpoint.Sm" Dense="true" Hover="true" RowsPerPage="25" Loading="true">
        <HeaderContent>
            <MudTh/>
            <MudTh>@L["Topic"]</MudTh>
            <MudTh>@L["History:Epoch"]</MudTh>
            <MudTh>@L["NumberOfTests:TotalPassed"]</MudTh>
            <MudTh>@L["TimeSpent:Total"]</MudTh>
            <MudTh/>
            <MudTh/>
        </HeaderContent>
        <RowTemplate>
            <MudTd HideSmall="true">
                <MudAvatar Image="@context.Image"/>
            </MudTd>
            <MudTd DataLabel="@L["Title"]">
                <MudLink Href="@Links.History.TopicById(context.Id)">
                    @context.Title
                </MudLink>
            </MudTd>
            <MudTd>
                <MudLink Href="@Links.History.TopicByEpoch(context.Epoch)">
                    @L[$"History:{context.Epoch}"]
                </MudLink>
            </MudTd>
            <MudTd DataLabel="@L["NumberOfTests:TotalPassed"]">
                @context.Progress.PassedTests.ToReadable()
            </MudTd>
            <MudTd DataLabel="@L["TimeSpent:Total"]">
                @context.Progress.TimeSpent.ToLongFormat()
            </MudTd>
            <MudTd>
                <FavoriteToggleButton
                    IsFavorite="@context.IsFavorite"
                    TopicId="@context.Id"
                    OnFavoriteClick="@OnFavoriteClick"/>
            </MudTd>
            <MudTd>
                <MudTooltip Text="@L["Details"]">
                    <MudIconButton Link="@Links.History.MyTopic(context.Id)" Icon="@Icons.Material.Outlined.ReadMore"/>
                </MudTooltip>
            </MudTd>
        </RowTemplate>
        <NoRecordsContent>
            <EmptyResult
                Class="grid-full-row"
                Title="@L["Profile:EmptyFavoritesTitle"]"
                Subtitle="@L["Profile:EmptyFavoritesSubtitle"]"/>
        </NoRecordsContent>
        <LoadingContent>
            <MudText>@L["Loading"]</MudText>
        </LoadingContent>
        <PagerContent>
            <MudTablePager RowsPerPageString="@L["RowsPerPage"]" />
        </PagerContent>
    </MudTable>


</MainContainer>

@code {
    private TopicsRequest _request = new(false, TopicsRequest.SortType.DateAddedNewest, 1, 20);

    private List<BreadcrumbItem> Breadcrumbs => new()
    {
        new BreadcrumbItem(L["Account"].Value, Links.Account.Index),
        new BreadcrumbItem(L["Profile"].Value, Links.History.MyProfile)
    };

    [Inject]
    private IHistoryClient HistoryClient { get; set; } = default!;

    [Inject]
    private IStringLocalizer<App> L { get; set; } = default!;

    private async Task<TableData<UserTopicSummary>> ServerReload(TableState state)
    {
        _request = _request with { Page = state.Page + 1, Count = (short)state.PageSize };

        var data = await HistoryClient.Me.GetTopicsAsync(_request);

        return new TableData<UserTopicSummary>
        {
            Items = data.Data.Items,
            TotalItems = (int)data.Data.Count
        };
    }

    private async Task<bool> OnFavoriteClick(string topicId)
    {
        var result = await HistoryClient.Topic.ToggleFavoriteAsync(topicId);
        return result.Status == ResponseStatus.Success && result.Data;
    }

}
