@page "/history/tests/{id}/conclusion"
@using Education.Web.Gateways.History.Tests.Model
@using Education.Web.Pages.History.Tests.Conclusion.Components
@using Education.Web.Gateways.History
@layout HistoryLayout
@attribute [Authorize]

<EduPage ShowFooter="@_response.IsLoaded">
    <ApiViewer Response="@_response" Context="conclusion">
        <MudAlert Class="mb-6 mb-sm-12" Severity="@GetColor(conclusion.Status)" Square ContentAlignment="HorizontalAlignment.Center">
            @L[$"ConclusionStatus:{conclusion.Status}"]
        </MudAlert>

        <CompletedStars Progress="@_progress" Class="mb-6"/>

        <RewardsContainer MaxWidth="EduWidth.W1280" Rewards="@conclusion.Rewards"/>

        @switch (conclusion)
        {
            case EasyTestConclusionModel test:
                <PageTitle>@L["Test:Easy"]: @test.Topic.Title</PageTitle>
                <EasyTestView Conclusion="@test"/>
                break;

            case HardTestConclusionModel test:
                <PageTitle>@L["Test:Hard"]: @test.Topic.Title</PageTitle>
                <HardTestView Conclusion="@test"/>
                break;

            case MixedTestConclusionModel test:
                <PageTitle>@L["Test:Mixed"]</PageTitle>
                <MixedTestView Conclusion="@test"/>
                break;

            default:
                throw new ArgumentOutOfRangeException(nameof(conclusion));
        }
    </ApiViewer>
</EduPage>

@code {
    private ApiResponse<TestConclusionModel> _response = ApiResponse<TestConclusionModel>.Loading();
    private double _progress;

    [Inject]
    private IHistoryClient HistoryClient { get; set; } = default!;

    [Inject]
    private IStringLocalizer<App> L { get; set; } = default!;

    [Inject]
    private NavigationManager Navigation { get; set; } = default!;

    [Parameter]
    public string Id { get; set; } = string.Empty;

    protected override async Task OnParametersSetAsync()
    {
        _response = await HistoryClient.Test.GetConclusionAsync(Id);
        if (_response.IsFailed)
        {
            if (_response.Error.IsTestNotFound())
                Navigation.NavigateTo(HistoryLinks.TopicTest.Index());

            return;
        }

        _progress = Math.Round((double)_response.Data.UserScore.Total / _response.Data.MaxScore.Total * 100);
    }

    private static Severity GetColor(ConclusionStatus status) =>
        status switch {
            ConclusionStatus.Succeeded => Severity.Success,
            ConclusionStatus.Failed => Severity.Error,
            ConclusionStatus.TimeExceeded => Severity.Warning,
            ConclusionStatus.MistakesExceeded => Severity.Warning,
            _ => Severity.Info
            };

}
