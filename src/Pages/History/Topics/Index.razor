@page "/history/topics/{id}"
@using Education.Web.Gateways.History
@using Education.Web.Gateways.History.Topics.Model
@using Education.Web.Pages.History.Topics.Components
@layout HistoryLayout

@attribute [Authorize]

<EduPage ShowFooter="@_result.IsLoaded">
    <ApiViewer Result="@_result" Context="result">
        <PageTitle>@result.Topic.Title</PageTitle>
        @switch (result.Topic)
        {
            case BattleTopicDetailModel battle:
                <BattleDetail
                    Battle="@battle"
                    Rating="@result.Rating"
                    HasTest="@result.HasTest"
                    UserActivity="@result.UserActivity"
                    RelatedTopics="@result.RelatedTopics"
                    OnLikeClick="LikeAsync"
                    OnDislikeClick="DislikeAsync"
                    OnFavoriteClick="@ToggleFavoriteAsync"
                    Breadcrumbs="@_breadcrumbs"/>
                break;

            case EmpireTopicDetailModel empire:
                <EmpireDetail
                    Empire="@empire"
                    Rating="@result.Rating"
                    HasTest="@result.HasTest"
                    UserActivity="@result.UserActivity"
                    RelatedTopics="@result.RelatedTopics"
                    OnLikeClick="LikeAsync"
                    OnDislikeClick="DislikeAsync"
                    OnFavoriteClick="@ToggleFavoriteAsync"
                    Breadcrumbs="@_breadcrumbs"/>
                break;

            case GeneralTopicDetailModel topic:
                <GeneralDetail
                    Topic="@topic"
                    Rating="@result.Rating"
                    HasTest="@result.HasTest"
                    UserActivity="@result.UserActivity"
                    RelatedTopics="@result.RelatedTopics"
                    OnLikeClick="LikeAsync"
                    OnDislikeClick="DislikeAsync"
                    OnFavoriteClick="@ToggleFavoriteAsync"
                    Breadcrumbs="@_breadcrumbs"/>
                break;

            case PersonTopicDetailModel person:
                <PersonDetail
                    Person="@person"
                    Rating="@result.Rating"
                    HasTest="@result.HasTest"
                    UserActivity="@result.UserActivity"
                    RelatedTopics="@result.RelatedTopics"
                    OnLikeClick="LikeAsync"
                    OnDislikeClick="DislikeAsync"
                    OnFavoriteClick="@ToggleFavoriteAsync"
                    Breadcrumbs="@_breadcrumbs"/>
                break;
        }
    </ApiViewer>
</EduPage>

@code {
    private List<BreadcrumbItem> _breadcrumbs = new();
    private ApiResult<TopicDetailCompositionModel> _result = ApiResult<TopicDetailCompositionModel>.Loading();

    [Inject]
    private IHistoryClient HistoryClient { get; set; } = default!;

    [Inject]
    private IStringLocalizer<App> L { get; set; } = default!;

    [Inject]
    private TopicContentFormatService FormatService { get; set; } = default!;
    
    [Parameter]
    public string Id { get; set; } = string.Empty;

    protected override async Task OnParametersSetAsync()
    {
        _result = ApiResult<TopicDetailCompositionModel>.Loading();
        _result = await HistoryClient.Topic.GetAsync(Id);

        if (_result.IsSuccess)
        {
            var epoch = _result.Data.Topic.Epoch;
            _breadcrumbs = new List<BreadcrumbItem>
            {
                new(L["Subject:History"], HistoryLinks.Root),
                new(L[$"Epoch:{epoch.ToFastString()}"], HistoryLinks.Content.Epoch(epoch))
            };
        }
    }

    protected override async Task OnInitializedAsync() => 
        await FormatService.InitAsync();

    private async Task<bool> LikeAsync()
    {
        var response = await HistoryClient.Topic.LikeAsync(Id);
        return response.IsSuccess;
    }

    private async Task<bool> DislikeAsync()
    {
        var response = await HistoryClient.Topic.DislikeAsync(Id);
        return response.IsSuccess;
    }

    private async Task<bool> ToggleFavoriteAsync(string id)
    {
        var result = await HistoryClient.Topic.ToggleFavoriteAsync(id);
        return result.IsSuccess && result.Data;
    }

}