@page "/history/leaderboards/monthly"
@using Education.Web.Gateways.History.Leaderboards.Model
@using Education.Web.Pages.History.Leaderboards.Components
@using Education.Web.Gateways.History
@layout HistoryLayout
@attribute [Authorize]

<EduPage ShowFooter="@_response.IsLoaded">
    <EduContainer MaxWidth="EduWidth.W1920" Class="pb-0">
        <PageHeader Title="@L["Leaderboard:Monthly:Name"]" Breadcrumbs="@Breadcrumbs"/>
    </EduContainer>

    <ApiViewer Response="@_response" Context="leaderboard">
        <EduContainer MaxWidth="EduWidth.W1920">
            <MudText Typo="Typo.h6">
                @leaderboard.Range.Starts.ToFullFormat() - @leaderboard.Range.Ends.ToFullFormat()
            </MudText>
            <RankingTable HighlightUser="@_highlightUser" Users="@leaderboard.Users"/>
        </EduContainer>
    </ApiViewer>
</EduPage>

@code {
    private long _highlightUser;
    private ApiResponse<MonthlyLeaderboardModel> _response = ApiResponse<MonthlyLeaderboardModel>.Loading();

    private List<BreadcrumbItem> Breadcrumbs => new()
    {
        new BreadcrumbItem(L["Subject:History"].Value, HistoryLinks.Root)
    };

    [Inject]
    private IHistoryClient Client { get; set; } = default!;

    [Inject]
    private IStringLocalizer<App> L { get; set; } = default!;

    [Inject]
    public AuthenticationStateProvider StateProvider { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        _response = await Client.Leaderboard.GetCurrentMonthAsync(100);
        var state = await StateProvider.GetAuthenticationStateAsync();
        if (state.User.Identity?.IsAuthenticated ?? false)
            _highlightUser = state.User.GetId();
    }

}
