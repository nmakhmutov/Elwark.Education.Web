@using Education.Web.Services.History.Topic
@using Education.Web.Services.History.User.Request
@using Education.Web.Services.History
@using Education.Web.Services.History.User

@page "/history/my/favorites"
@layout HistoryLayout
@attribute [Authorize]

<PageTitle>@L["Favorites"]</PageTitle>
<EduPage>
    <EduContainer MaxWidth="EduWidth.W1920">
        <EduPageHeader Title="@L["Favorites"]" Breadcrumbs="@Breadcrumbs">
            @if (!_isEmpty)
            {
                <div>
                    <MudSelect Label="@L["Favorites:Sort"]" T="FavoritesRequest.SortType" Value="@_request.Sort" ValueChanged="@OnSortChanged">
                        @foreach (var sort in FavoritesRequest.SortTypes)
                        {
                            <MudSelectItem T="FavoritesRequest.SortType" Value="sort.Key">
                                @L[$"Favorites:{sort.Value}"]
                            </MudSelectItem>
                        }
                    </MudSelect>
                </div>
            }
        </EduPageHeader>
    </EduContainer>
    @if (_isLoading)
    {
        <Spinner/>
    }
    else
    {
        <EduContainer MaxWidth="EduWidth.W1920">
            @if (_isEmpty)
            {
                <EduEmpty
                    Class="grid-full-row"
                    Title="@L["Favorites:EmptyTitle"]"
                    Subtitle="@L["Favorites:EmptySubtitle"]"/>
            }
            else
            {
                <div class="grid px-3 px-sm-6 mb-3">
                    <div class="image"></div>
                    <div class="title">@L["Topic:Title"]</div>
                    <div class="epoch">@L["History:Epoch"]</div>
                    <div class="rating">@L["Rating"]</div>
                    <div class="passed-test">@L["NumberOfTests:TotalPassed"]</div>
                    <div class="time-spent">@L["TimeSpent:Total"]</div>
                    <div class="actions"></div>
                </div>
                <Virtualize @ref="@_virtualize" ItemsProvider="FavoriteDataProvider" ItemSize="110" Context="item">
                    <div class="grid mud-paper pa-3 pa-sm-6 mb-3 mb-sm-6">
                        <div class="image">
                            <MudAvatar Size="Size.Large" Image="@item.Topic.ThumbnailUrl"/>
                        </div>
                        <div class="title">
                            <MudLink Href="@HistoryUrl.Content.Topic(item.Topic.Id)">
                                @item.Topic.Title
                            </MudLink>
                        </div>
                        <div class="epoch">
                            <MudChip Class="mx-0" Label DisableRipple Size="Size.Small" Variant="Variant.Text" Color="Color.Primary" Link="@HistoryUrl.Content.Epoch(item.Topic.Epoch)">
                                @L[$"Epoch:{item.Topic.Epoch.ToFastString()}"]
                            </MudChip>
                        </div>
                        <div class="rating">
                            <TopicRating Rating="@item.Topic.Rating" ShowDetails Class="d-inline-flex flex-column align-center"/>
                        </div>
                        <div class="passed-test">
                            <div class="d-flex align-center">
                                <MudIcon Icon="@EduIcons.Tests" Size="Size.Small" Class="mr-1"/>
                                <MudText Typo="Typo.body2">
                                    @item.Activity.PassedTests.ToReadable()
                                </MudText>
                            </div>
                        </div>
                        <div class="time-spent">
                            <div class="d-flex align-center">
                                <MudIcon Icon="@EduIcons.TimeSpent" Size="Size.Small" Class="mr-1"/>
                                <MudText Typo="Typo.body2">
                                    @item.Activity.TimeSpent.ToSimpleFormat()
                                </MudText>
                            </div>
                        </div>
                        <div class="actions">
                            @if (item.Activity.PassedTests > 0)
                            {
                                <MudTooltip Text="@L["Button:Details"]">
                                    <MudIconButton
                                        Link="@HistoryUrl.User.MyTopic(item.Topic.Id)"
                                        Icon="@Icons.Outlined.RemoveRedEye"/>
                                </MudTooltip>
                            }
                            <FavoriteButton
                                IsFavorite="@item.Activity.IsFavorite"
                                TopicId="@item.Topic.Id"
                                OnFavoriteClick="@OnFavoriteClick"/>
                        </div>
                    </div>

                </Virtualize>
            }
        </EduContainer>
    }
</EduPage>

@code {
    private bool _isLoading = true;
    private bool _isEmpty = true;
    private Virtualize<UserTopicOverviewModel> _virtualize = default!;
    private readonly List<UserTopicOverviewModel> _items = new();
    private FavoritesRequest _request = new(FavoritesRequest.SortType.DateAddedNewest, 20);

    private List<BreadcrumbItem> Breadcrumbs => new()
    {
        new BreadcrumbItem(L["History"].Value, HistoryUrl.Root),
        new BreadcrumbItem(L["Profile"].Value, HistoryUrl.User.MyProfile)
    };

    [Inject]
    private IHistoryUserService UserService { get; set; } = default!;

    [Inject]
    private IHistoryTopicService TopicService { get; set; } = default!;
    
    [Inject]
    private IStringLocalizer<App> L { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        var data = await UserService.GetFavoritesAsync(_request);
        if (data.IsSuccess)
        {
            _request = _request with { Token = data.Data.Next };
            _items.AddRange(data.Data.Items);
        }

        _isEmpty = _items.Count == 0;
        _isLoading = false;
    }

    private async ValueTask<ItemsProviderResult<UserTopicOverviewModel>> FavoriteDataProvider(ItemsProviderRequest request)
    {
        int GetLength() =>
            _items.Count + (string.IsNullOrEmpty(_request.Token) ? 0 : 1);

        var isRangeAvailable = _items.Count > (request.StartIndex + 1) * request.Count ||
                               _items.Count > 0 && string.IsNullOrEmpty(_request.Token);

        if (isRangeAvailable)
            return new ItemsProviderResult<UserTopicOverviewModel>(_items.Skip(request.StartIndex).Take(request.Count), GetLength());

        var data = await UserService.GetFavoritesAsync(_request = _request with { Count = request.Count });
        if (data.IsFailed)
            return new ItemsProviderResult<UserTopicOverviewModel>(_items, GetLength());

        _request = _request with { Token = data.Data.Next };
        _items.AddRange(data.Data.Items);

        return new ItemsProviderResult<UserTopicOverviewModel>(_items.Skip(request.StartIndex), GetLength());
    }

    private async Task<bool> OnFavoriteClick(string topicId)
    {
        var result = await TopicService.ToggleFavoriteAsync(topicId);
        return result is { IsSuccess: true, Data: true };
    }

    private Task OnSortChanged(FavoritesRequest.SortType sort)
    {
        _request = _request with { Sort = sort, Token = null };
        _items.Clear();

        return _virtualize.RefreshDataAsync();
    }

}
