@page "/history/my/achievements"
@layout HistoryLayout

@using Education.Web.Pages.History.My.Components
@using Education.Web.Services.History.User
@using Education.Web.Services.History.User.Model

@attribute [Authorize]

<PageTitle>@L["Achievements"]</PageTitle>
<EduPage ShowFooter="@_result.IsLoaded">
    <EduContainer Class="pb-0">
        <PageHeader Title="@L["Achievements"]" Breadcrumbs="@Breadcrumbs">
            <MudText Typo="Typo.h5">
                @_subtitle
            </MudText>
        </PageHeader>
    </EduContainer>
    <ApiViewer Result="@_result" Context="achievements">
        <EduContainer>
            <MudGrid>
                @for (var index = 0; index < achievements.Categories.Length; index++)
                {
                    var category = achievements.Categories[index];
                    var classes = index == 0 ? null : "mt-6 mt-sm-16";

                    <MudItem xs="12" md="3" xl="2" Class="@classes">
                        <div class="sticky-info">
                            <div class="d-flex align-end">
                                <MudText Typo="@Typo.h5">
                                    @category.Title
                                </MudText>
                                <MudText Typo="@Typo.subtitle1" Class="ml-3">
                                    @category.Completed/@category.Total
                                </MudText>
                            </div>

                            <MudText Typo="@Typo.body1">
                                @category.Description
                            </MudText>
                        </div>
                    </MudItem>

                    <MudItem xs="12" md="9" xl="10" Class="@classes">
                        <div class="grid">
                            @foreach (var achievement in category.Achievements)
                            {
                                <MudCard Elevation="0">
                                    <MudCardContent Class="pa-3 pa-sm-6">
                                        <AchievementView Achievement="@achievement"/>
                                    </MudCardContent>
                                </MudCard>
                            }
                        </div>
                    </MudItem>
                }
            </MudGrid>
        </EduContainer>
    </ApiViewer>
</EduPage>

@code {
    private string? _subtitle;

    private List<BreadcrumbItem> Breadcrumbs => new()
    {
        new BreadcrumbItem(L["Profile"].Value, HistoryLinks.User.MyProfile)
    };

    private ApiResult<AchievementsDetailModel> _result = ApiResult<AchievementsDetailModel>.Loading();

    [Inject]
    private IStringLocalizer<App> L { get; set; } = default!;

    [Inject]
    private IHistoryUserService UserService { get; set; } = default!;

    protected override async Task OnParametersSetAsync()
    {
        _result = await UserService.GetAchievementsAsync();
        if (_result.IsSuccess)
            _subtitle = $"{_result.Data.Completed} / {_result.Data.Total}";
    }

}
