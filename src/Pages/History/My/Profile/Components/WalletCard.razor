@using ApexCharts
@using Education.Web.Services.Model
@using Education.Web.Services.Model.User
@using Color = MudBlazor.Color
@using Align = MudBlazor.Align

<section class="@($"mud-paper d-flex flex-column pa-3 {Class}")">
    <header class="mud-primary white-text rounded pa-3">
        <div class="d-flex align-center justify-space-between">
            <MudText Typo="Typo.subtitle1">
                @L["InternalMoney:Balance"]
            </MudText>
            <MudChip Label Icon="@_tendingIcon" Class="white-text" Text="@($"{_tendingValue:F1}%")"/>
        </div>
        <div class="d-flex align-center justify-space-between">
            <div class="d-flex align-center">
                <MudIcon Icon="@EduIcons.Silver" Class="mr-1" Size="Size.Medium"/>
                <ReadableNumber Value="@Silver.Balance" Typo="Typo.h4" Class="white-text"/>
            </div>
            <ApexChart TItem="SilverWalletModel.CashFlow" Options="@_options" Width="@("80px")" Height="@("30px")">
                <ApexPointSeries
                    TItem="SilverWalletModel.CashFlow"
                    Items="@Silver.Flow"
                    SeriesType="SeriesType.Line"
                    XValue="@(x => x.Month.ToDateTime(TimeOnly.MinValue, DateTimeKind.Utc))"
                    YValue="@(x => x.Balance)"
                    OrderBy="@(x => x.X)"/>
            </ApexChart>
        </div>
    </header>

    @if (_flows.Length > 0)
    {
        foreach (var item in _flows)
        {
            <MudStack Row AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mt-3">
                <MudStack Row AlignItems="AlignItems.Center">
                    <MudAvatar Size="Size.Medium" Color="Color.Primary" Class="rounded white-text">
                        <MudIcon Icon="@Icons.Outlined.CalendarMonth" Size="Size.Medium"/>
                    </MudAvatar>
                    <MudText Typo="Typo.subtitle2" Align="Align.Start">
                        @L[$"Month:{CultureInfo.InvariantCulture.DateTimeFormat.GetMonthName(item.Month.Month)}"]
                    </MudText>
                </MudStack>
                <MudStack Row AlignItems="AlignItems.Center">
                    <div>
                        <InternalMoney Horizontal IconSize="Size.Small" Money="@(new Silver(item.Income))"/>
                        <MudText Typo="Typo.caption" Class="mud-text-secondary">
                            @L["InternalMoney:Income"]
                        </MudText>
                    </div>
                    <div>
                        <InternalMoney Horizontal IconSize="Size.Small" Money="@(new Silver(item.Expense))"/>
                        <MudText Typo="Typo.caption" Class="mud-text-secondary">
                            @L["InternalMoney:Expense"]
                        </MudText>
                    </div>
                </MudStack>
            </MudStack>
        }
    }
    else
    {
        <EduEmpty
            Class="empty-flow"
            Title="@L["InternalMoney:EmptyFlow"]"
            TitleTypo="Typo.subtitle1"/>
    }

</section>

@code {
    private double _tendingValue;
    private string? _tendingIcon;
    private SilverWalletModel.CashFlow[] _flows = Array.Empty<SilverWalletModel.CashFlow>();

    private ApexChartOptions<SilverWalletModel.CashFlow> _options = new()
    {
        Tooltip = new Tooltip
        {
            Enabled = false
        },
        Chart = new Chart
        {
            Background = "transparent",
            ForeColor = "var(--mud-palette-text-primary)",
            Sparkline = new ChartSparkline
            {
                Enabled = true
            }
        },
        Stroke = new Stroke
        {
            Colors = new List<string>
            {
                "#FFFFFF"
            },
            Curve = Curve.Smooth,
            Width = 3
        }
    };

    [Inject]
    public IStringLocalizer<App> L { get; set; } = default!;

    [Parameter, EditorRequired]
    public SilverWalletModel Silver { get; set; } = default!;

    [Parameter]
    public string? Class { get; set; }

    protected override void OnParametersSet()
    {
        _flows = Silver.Flow.Where(x => x.Balance > 0).Take(3).ToArray();

        var current = Silver.Flow[0].Income + Silver.Flow[0].Expense;
        var last = Silver.Flow[1].Income + Silver.Flow[1].Expense;

        _tendingValue = (current * 100.0 / last) switch
        {
            double.NaN => 0,
            double.PositiveInfinity => 100,
            double.NegativeInfinity => -100,
            var x => Math.Round(x, 1)
            };

        _tendingIcon = _tendingValue switch
        {
            > 0 => Icons.Outlined.TrendingUp,
            < 0 => Icons.Outlined.TrendingDown,
            _ => Icons.Outlined.TrendingFlat
            };
    }

}