@implements IDisposable

<MudText Typo="@Typo" Align="@Align" Class="@Class" Color="@Color">
    @_timeLeft.Humanize()
</MudText>

@code {
    private TimeSpan _timeLeft = TimeSpan.Zero;
    private readonly PeriodicTimer _timer = new(TimeSpan.FromSeconds(1));

    [Parameter, EditorRequired]
    public DateTime Deadline { get; set; }

    [Parameter]
    public Typo Typo { get; set; } = Typo.subtitle1;

    [Parameter]
    public Align Align { get; set; } = Align.Inherit;

    [Parameter]
    public Color Color { get; set; } = Color.Default;

    [Parameter]
    public string? Class { get; set; }

    [Parameter]
    public EventCallback OnComplete { get; set; }

    protected override Task OnInitializedAsync() =>
        InvokeAsync(async () =>
        {
            UpdateRemainingTime();

            while (await _timer.WaitForNextTickAsync())
            {
                if (TimeSpan.Zero >= _timeLeft)
                    break;

                UpdateRemainingTime();
                StateHasChanged();
            }

            if (OnComplete.HasDelegate)
                await OnComplete.InvokeAsync();
        });

    private void UpdateRemainingTime() =>
        _timeLeft = new TimeSpan(Deadline.Ticks - DateTime.UtcNow.Ticks / TimeSpan.TicksPerSecond * TimeSpan.TicksPerSecond);

    public void Dispose() =>
        _timer.Dispose();

}