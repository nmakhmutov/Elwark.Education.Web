@using Education.Web.Client.Pages.History.My.Components
@using Education.Web.Client.Services.History.User.Model
@using Education.Web.Client.Services.History.User

@page "/history/my/achievements"
@layout HistoryLayout
@attribute [Authorize]

<EduPage Title="@L["Achievements"]">
    <EduContainer Class="py-3 py-sm-6">
        <EduPageHeader Title="@L["Achievements"]" Breadcrumbs="@Breadcrumbs">
            <MudText Typo="Typo.h5">
                @_subtitle
            </MudText>
        </EduPageHeader>
    </EduContainer>
    <ApiViewer Result="@_result" Context="achievements">
        <EduContainer Class="pb-3 pb-sm-6">
            <MudGrid>
                @for (var index = 0; index < achievements.Categories.Length; index++)
                {
                    var category = achievements.Categories[index];
                    var background = GetIconBackground(category.Name);
                    var classes = index == 0 ? null : "mt-6 mt-sm-16";

                    <MudItem xs="12" md="3" xl="2" Class="@classes">
                        <div class="sticky-info">
                            <div class="d-flex align-end">
                                <MudText Typo="@Typo.h5">
                                    @category.Title
                                </MudText>
                                <MudText Typo="@Typo.subtitle1" Class="ml-3">
                                    @category.Completed/@category.Total
                                </MudText>
                            </div>

                            <MudText Typo="@Typo.body1">
                                @category.Description
                            </MudText>
                        </div>
                    </MudItem>

                    <MudItem xs="12" md="9" xl="10" Class="@classes">
                        <EduFillGrid>
                            @foreach (var achievement in category.Achievements)
                            {
                                <AchievementView 
                                    Class="mud-paper pa-3 pa-sm-6" 
                                    IconClass="@background" 
                                    Achievement="@achievement"/>
                            }
                        </EduFillGrid>
                    </MudItem>
                }
            </MudGrid>
        </EduContainer>
    </ApiViewer>
</EduPage>

@code {
    private string? _subtitle;

    private List<BreadcrumbItem> Breadcrumbs => new()
    {
        new BreadcrumbItem(L["History"].Value, HistoryUrl.Root),
        new BreadcrumbItem(L["Profile"].Value, HistoryUrl.User.MyProfile)
    };

    private ApiResult<AchievementsDetailModel> _result = ApiResult<AchievementsDetailModel>.Loading();

    [Inject]
    private IStringLocalizer<App> L { get; set; } = default!;

    [Inject]
    private IHistoryUserService UserService { get; set; } = default!;

    protected override async Task OnParametersSetAsync()
    {
        _result = await UserService.GetAchievementsAsync();
        if (_result.IsSuccess)
            _subtitle = $"{_result.Value.Completed} / {_result.Value.Total}";
    }

    private static string GetIconBackground(string category) =>
        category switch {
            "EasyTest" => "blue lighten-3 white-text",
            "HardTest" => "blue lighten-1 white-text",
            "MixedTest" => "blue darken-2 white-text",
            "Tests" => "blue darken-4 white-text",
            "EventGuessers" => "orange darken-4 white-text",
            "Earning" => "green accent-2 white-text",
            "Level" => "green accent-3 white-text",
            "Quests" => "green accent-4 white-text",
            _ => "pink accent-4 white-text"
            };

}