@using ApexCharts
@using Education.Web.Client.Services.History.User.Model
@using Microsoft.VisualBasic
@using Color = MudBlazor.Color
@using Align = MudBlazor.Align

<section class="mud-paper d-flex flex-column @Class">
    <header class="mud-primary white-text rounded ma-3 pa-3">
        <div class="d-flex align-center justify-space-between">
            <div class="d-flex align-center">
                <MudIcon Class="mr-1" Icon="@Icon" Size="Size.Medium"/>
                <MudText Typo="Typo.h6">
                    @Title
                </MudText>
            </div>

            <div class="d-flex flex-column">
                <MudChip Class="white-text ma-0" Label Icon="@_tendingIcon" Text="@($"{_tendingValue:F1}%")"/>
                @if (Budget.Length > 0)
                {
                    <div class="mb-3"></div>
                    <ApexChart TItem="ApexData" Options="@_options" Width="@("100px")" Height="@("30px")">
                        <ApexPointSeries
                            TItem="ApexData"
                            Items="@_apex"
                            SeriesType="SeriesType.Line"
                            XValue="@(x => x.Month)"
                            YValue="@(x => x.Balance)"
                            OrderBy="@(x => x.X)"/>
                    </ApexChart>
                }
            </div>
        </div>
    </header>

    @if (Budget.Length > 0)
    {
        foreach (var item in Budget)
        {
            <div class="@_budgetItemClass">
                <div class="d-flex align-center flex-grow-1">
                    <MudAvatar Class="rounded white-text mr-3" Color="@(item.Balance == 0 ? Color.Default : Color.Primary)" Size="Size.Medium">
                        <MudIcon Icon="@Icons.Material.Outlined.CalendarMonth" Size="Size.Medium"/>
                    </MudAvatar>
                    <MudText Typo="Typo.subtitle2" Align="Align.Start">
                        @L[$"Month:{CultureInfo.InvariantCulture.DateTimeFormat.GetMonthName(item.Month.Month)}"]
                    </MudText>
                </div>
                <div>
                    <div class="d-flex align-center">
                        <MudIcon Class="mr-1" Size="Size.Small" Icon="@Icon"/>
                        <ReadableNumber Value="@item.Income" Typo="Typo.body1"/>
                    </div>
                    <MudText Class="mud-text-secondary" Typo="Typo.caption">
                        @L["InternalMoney:Income"]
                    </MudText>
                </div>
                <div>
                    <div class="d-flex align-center">
                        <MudIcon Class="mr-1" Size="Size.Small" Icon="@Icon"/>
                        <ReadableNumber Value="@item.Expense" Typo="Typo.body1"/>
                    </div>
                    <MudText Class="mud-text-secondary" Typo="Typo.caption">
                        @L["InternalMoney:Expense"]
                    </MudText>
                </div>
            </div>
        }
    }
    else
    {
        <div class="d-flex align-center gap-3 pa-3 pa-sm-6">
            <MudAvatar Class="rounded white-text mr-3" Color="@Color.Default" Size="Size.Large">
                <MudIcon Icon="@Icons.Material.Outlined.HourglassEmpty" Size="Size.Medium"/>
            </MudAvatar>
            <div>
                <MudText Typo="Typo.subtitle2" Align="Align.Start">
                    @L["InternalMoney:EmptyBalanceTitle"]
                </MudText>
                <MudText Typo="Typo.body2" Align="Align.Start">
                    @L["InternalMoney:EmptyBalanceSubtitle"]
                </MudText>
            </div>
        </div>
    }

    @if (!string.IsNullOrEmpty(Href))
    {
        <div class="flex-grow-1"></div>

        <footer class="pa-3 pa-sm-6">
            <MudButton DisableElevation Variant="Variant.Outlined" Color="Color.Primary" Href="@Href">
                @L["Button:Details"]
            </MudButton>
        </footer>
    }
</section>

@code {
    private double _tendingValue;
    private string? _tendingIcon;
    private string? _budgetItemClass;
    private readonly List<ApexData> _apex = new();

    private readonly ApexChartOptions<ApexData> _options = new()
    {
        Tooltip = new Tooltip
        {
            Enabled = false
        },
        Chart = new Chart
        {
            Background = "transparent",
            ForeColor = "var(--mud-palette-text-primary)",
            Sparkline = new ChartSparkline
            {
                Enabled = true
            }
        },
        Stroke = new Stroke
        {
            Colors = new List<string>
            {
                "#FFFFFF"
            },
            Curve = Curve.Smooth,
            Width = 3
        }
    };

    [Inject]
    public IStringLocalizer<App> L { get; set; } = default!;

    [Parameter, EditorRequired]
    public BudgetModel[] Budget { get; set; } = default!;

    [Parameter, EditorRequired]
    public string? Title { get; set; }

    [Parameter, EditorRequired]
    public string? Icon { get; set; }

    [Parameter]
    public string? Href { get; set; }

    [Parameter]
    public string? Class { get; set; }

    protected override void OnParametersSet()
    {
        var now = DateTime.UtcNow;
        var month = new DateOnly(now.Year, now.Month, 1);
        for (var i = 0; i < 6; i++)
        {
            var current = month.AddMonths(-i);
            _apex.Add(
                Budget.FirstOrDefault(x => x.Month == current) is {} item
                    ? new ApexData(item.Month.ToDateTime(TimeOnly.MinValue), item.Balance)
                    : new ApexData(current.ToDateTime(TimeOnly.MinValue), 0)
                );
        }

        var (start, end) = Budget switch {
            [] => (0d, 0d),
            [var first] => (first.Balance, 0d),
            [var first, var second, ..] => (first.Balance, second.Balance)
            };

        _tendingValue = ((start - end) / end * 100) switch
        {
            double.NaN => 0,
            double.PositiveInfinity => 100,
            double.NegativeInfinity => -100,
            var x => start > end ? Math.Abs(x) : -Math.Abs(x)
            };

        _tendingIcon = _tendingValue switch
        {
            > 0 => Icons.Material.Outlined.TrendingUp,
            < 0 => Icons.Material.Outlined.TrendingDown,
            _ => Icons.Material.Outlined.TrendingFlat
            };

        _budgetItemClass = string.IsNullOrEmpty(Href)
            ? "d-flex align-center gap-3 gap-sm-6 py-3 px-3" 
            : "d-flex align-center gap-3 gap-sm-6 py-3 px-3 px-sm-6";
    }

    private sealed record ApexData(DateTime Month, long Balance);
}