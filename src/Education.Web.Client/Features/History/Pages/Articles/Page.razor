@page "/history/articles"
@using Education.Web.Client.Features.History.Services
@using Education.Web.Client.Features.History.Services.Article
@using Education.Web.Client.Features.History.Services.Article.Request
@using Education.Web.Client.Features.History.Services.User
@using Education.Web.Client.Models
@layout HistoryLayout

<PageTitle>
    @L["History_Articles"]
</PageTitle>

<EduContainer Class="py-3 py-sm-6">
    <EduPageHeader Title="@L["History_Articles"]" Breadcrumbs="@Breadcrumbs"/>
</EduContainer>

<ApiViewer Result="_result" Context="result">
    <EduContainer>
        <EduFillGrid Class="mb-6 mb-sm-12">
            @foreach (var (article, activity) in result.Items)
            {
                <ArticleCard
                    Article="@article"
                    Activity="@activity"
                    OnBookmarkClick="@OnBookmarkClick"/>
            }
        </EduFillGrid>
        <MudPagination
            Class="d-flex justify-center py-3 py-sm-6"
            Rectangular
            DisableElevation
            Selected="@CurrentPage"
            SelectedChanged="@OnPagination"
            Count="@TotalPages"/>
    </EduContainer>
</ApiViewer>

@code {
    private GetArticlesRequest _request = new(EpochType.None, GetArticlesRequest.SortType.Newest, 0, 20);
    private ApiResult<PagingOffsetModel<UserArticleOverviewModel>> _result = ApiResult<PagingOffsetModel<UserArticleOverviewModel>>.Loading();

    private List<BreadcrumbItem> Breadcrumbs => new()
    {
        new BreadcrumbItem(L["History_Title"].Value, HistoryUrl.Root)
    };

    [Inject]
    private IHistoryArticleService ArticleService { get; set; } = default!;

    [Inject]
    private IHistoryUserService UserService { get; set; } = default!;

    [Inject]
    private IStringLocalizer<App> L { get; set; } = default!;

    [Inject]
    private NavigationManager Navigation { get; set; } = default!;

    [Parameter, SupplyParameterFromQuery(Name = "epoch")]
    public string? EpochString { get; set; }

    [Parameter, SupplyParameterFromQuery(Name = "sort")]
    public string? SortString { get; set; }

    [Parameter, SupplyParameterFromQuery(Name = "page")]
    public int CurrentPage { get; set; }

    private int TotalPages => _result.IsSuccess
        ? (int)double.Ceiling((double)_result.Value.Count / _request.Limit)
        : 1;

    protected override async Task OnParametersSetAsync()
    {
        if (CurrentPage < 1)
            CurrentPage = 1;

        _request = _request with {
            Epoch = GetEpoch(),
            Sort = GetSort(),
            Offset = (CurrentPage - 1) * _request.Limit 
            };

        _result = await ArticleService
            .GetAsync(_request);
    }

    private async Task<bool> OnBookmarkClick(string articleId)
    {
        var result = await UserService.ToggleBookmarkAsync(articleId);
        return result is { IsSuccess: true, Value: true };
    }

    private void OnPagination(int page)
    {
        _result = ApiResult<PagingOffsetModel<UserArticleOverviewModel>>.Loading();
        Navigation.NavigateTo(Navigation.GetUriWithQueryParameter("page", page));
    }

    private EpochType GetEpoch()
    {
        if (string.IsNullOrEmpty(EpochString))
            return EpochType.None;

        if (Enum.TryParse<EpochType>(EpochString, true, out var value))
            return value;

        return EpochType.None;
    }

    private GetArticlesRequest.SortType GetSort()
    {
        if (string.IsNullOrEmpty(SortString))
            return GetArticlesRequest.SortType.Newest;

        if (Enum.TryParse<GetArticlesRequest.SortType>(SortString, true, out var value))
            return value;

        return GetArticlesRequest.SortType.Newest;
    }

}