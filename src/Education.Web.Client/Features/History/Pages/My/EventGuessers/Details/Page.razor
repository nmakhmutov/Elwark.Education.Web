@page "/history/my/event-guessers/{test}"
@using Education.Web.Client.Features.History.Services.Learner.Model.EventGuesser
@using Education.Web.Client.Features.History.Services.Learner
@layout HistoryLayout
@attribute [Authorize]

<PageTitle>
    @_title
</PageTitle>

<EduContainer Class="py-3 py-sm-6">
    <EduPageHeader Title="@_title" Breadcrumbs="@Breadcrumbs"/>
</EduContainer>

<ApiViewer Result="@_result" Context="result">
    <EduContainer Class="pb-3 pb-sm-6">
        <StatisticDetailsGrid>
            <StatisticDetailsCard>
                <TotalContent>
                    <Subheader Title="@L["History_EventGuesser_Score"]" Subtitle="@L["Statistics_ForAllTime"]"/>
                    <EventGuesserScoreChart Score="@result.Score"/>
                </TotalContent>
                <ProgressContent>
                    <Subheader Title="@L["Progress_Title"]" Subtitle="@result.Delta.RangeTitle()"/>
                    <ProgressList Items="@result.Delta.GetProgress(L)"/>
                </ProgressContent>
            </StatisticDetailsCard>

            <StatisticDetailsCard>
                <TotalContent>
                    <Subheader Title="@L["History_EventGuesser_Questions"]" Subtitle="@L["Statistics_ForAllTime"]"/>
                    <EventGuesserAnswerRatioChart AnswerRatio="@result.AnswerRatio"/>
                </TotalContent>
                <ProgressContent>
                    <Subheader Title="@L["Progress_Title"]" Subtitle="@result.Delta.RangeTitle()"/>
                    <ProgressList Items="@result.Delta.GetProgress(L)"/>
                </ProgressContent>
            </StatisticDetailsCard>

            <MudPaper Elevation="0" Class="pa-3 pa-sm-6">
                <MudStack Row Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-3 mb-sm-6">
                    <MudText Typo="Typo.h5">
                        @L["Quizzes_Title"]
                    </MudText>
                    <MetricNumber Value="@result.Tests" Typo="Typo.h5"/>
                </MudStack>
                <section>
                    <Subheader Title="@L["Progress_Title"]" Subtitle="@result.Delta.RangeTitle()"/>
                    <ProgressList Items="@result.Delta.GetProgress(L)"/>
                </section>
            </MudPaper>
        </StatisticDetailsGrid>
    </EduContainer>
</ApiViewer>

@code {
    private string? _title;
    private ApiResult<EventGuesserStatisticsModel> _result = ApiResult<EventGuesserStatisticsModel>.Loading();

    private List<BreadcrumbItem> Breadcrumbs => new()
    {
        new BreadcrumbItem(L["History_Title"], HistoryUrl.Root),
        new BreadcrumbItem(L["User_Profile_Title"], HistoryUrl.User.MyProfile),
        new BreadcrumbItem(L["History_EventGuessers_Title"], HistoryUrl.User.MyEventGuessers)
    };

    [Inject]
    private IStringLocalizer<App> L { get; set; } = default!;

    [Inject]
    private IHistoryLearnerService LearnerService { get; set; } = default!;

    [Parameter]
    public string? Test { get; set; }

    protected override void OnParametersSet() =>
        _title = Test?.ToLowerInvariant() switch {
            "small" => L["History_EventGuessers_Small"],
            "medium" => L["History_EventGuessers_Medium"],
            "large" => L["History_EventGuessers_Large"],
            _ => L["Error_NotFound"]
            };

    protected override async Task OnParametersSetAsync() =>
        _result = Test?.ToLowerInvariant() switch
        {
            "small" => await LearnerService.GetSmallEventGuesserStatisticsAsync(),
            "medium" => await LearnerService.GetMediumEventGuesserStatisticsAsync(),
            "large" => await LearnerService.GetLargeEventGuesserStatisticsAsync(),
            _ => ApiResult<EventGuesserStatisticsModel>.Fail(Error.Create(L["Error_NotFound"], 404))
            };

}