@page "/history/my/date-guessers"
@using Education.Web.Client.Features.History.Services.Learner
@using Education.Web.Client.Features.History.Services.Learner.Model.DateGuesser
@layout HistoryLayout
@attribute [Authorize]

<PageTitle>
    @L["History_DateGuessers_Title"]
</PageTitle>

<EduContainer Class="py-3 py-sm-6" MaxWidth="EduWidth.W1920">
    <EduPageHeader Title="@L["History_DateGuessers_Title"]" Breadcrumbs="@Breadcrumbs"/>
</EduContainer>

<ApiViewer Result="@_result" Context="profile">
    <EduContainer Class="pb-3 pb-sm-6" MaxWidth="EduWidth.W1920">
        <EduFillGrid>
            <StatisticsCard
                Title="@L["History_DateGuessers_Small"]"
                Value="@profile.SmallDateGuesser.Tests"
                Href="@HistoryUrl.User.MySmallDateGuessers">
                <Subheader Title="@L["Score_Title"]" Subtitle="@L["Statistics_ForAllTime"]"/>
                <DateGuesserScoreChart Score="@profile.SmallDateGuesser.Score"/>
            </StatisticsCard>

            <StatisticsCard
                Title="@L["History_DateGuessers_Medium"]"
                Value="@profile.MediumDateGuesser.Tests"
                Href="@HistoryUrl.User.MyMediumDateGuessers">
                <Subheader Title="@L["Score_Title"]" Subtitle="@L["Statistics_ForAllTime"]"/>
                <DateGuesserScoreChart Score="@profile.MediumDateGuesser.Score"/>
            </StatisticsCard>

            <StatisticsCard
                Title="@L["History_DateGuessers_Large"]"
                Value="@profile.LargeDateGuesser.Tests"
                Href="@HistoryUrl.User.MyLargeDateGuessers">
                <Subheader Title="@L["Score_Title"]" Subtitle="@L["Statistics_ForAllTime"]"/>
                <DateGuesserScoreChart Score="@profile.LargeDateGuesser.Score"/>
            </StatisticsCard>

            <ActivityCard
                Class="grid-column-sm-full"
                Title="@L["Activities_Daily_Title"]"
                Activities="@_daily"
                DateFormat="dd MMM"/>

            @if (_monthly.Length > 1)
            {
                <ActivityCard
                    Class="grid-column-full"
                    Title="@L["Activities_Monthly_Title"]"
                    Activities="@_monthly"
                    DateFormat="MMM yyyy"/>
            }
        </EduFillGrid>
    </EduContainer>
</ApiViewer>

@code {
    private DateGuessersStatisticsModel.ProgressModel[] _daily = Array.Empty<DateGuessersStatisticsModel.ProgressModel>();
    private DateGuessersStatisticsModel.ProgressModel[] _monthly = Array.Empty<DateGuessersStatisticsModel.ProgressModel>();
    private ApiResult<DateGuessersStatisticsModel> _result = ApiResult<DateGuessersStatisticsModel>.Loading();

    private List<BreadcrumbItem> Breadcrumbs => new()
    {
        new BreadcrumbItem(L["History_Title"], HistoryUrl.Root),
        new BreadcrumbItem(L["User_Profile_Title"], HistoryUrl.User.MyProfile)
    };

    [Inject]
    private IStringLocalizer<App> L { get; set; } = default!;

    [Inject]
    private IHistoryLearnerService LearnerService { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        _result = await LearnerService.GetDateGuesserStatisticsAsync();
        _result.Match(model =>
        {
            var today = DateOnly.FromDateTime(DateTime.UtcNow);
            _daily = model.Daily
                .FillDailyGaps(today, x => x.Date, x => new DateGuessersStatisticsModel.ProgressModel(x, 0, 0, 0))
                .ToArray();

            _monthly = model.Monthly
                .FillMonthlyGaps(today, x => x.Date, x => new DateGuessersStatisticsModel.ProgressModel(x, 0, 0, 0))
                .ToArray();
        });
    }

}