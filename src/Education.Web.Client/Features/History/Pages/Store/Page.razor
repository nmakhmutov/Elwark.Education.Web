@page "/history/store"
@using Education.Web.Client.Features.History.Services.User.Model
@using Education.Web.Client.Features.History.Services.Store
@using Education.Web.Client.Features.History.Services.Store.Model
@using Education.Web.Client.Features.History.Services.User

@layout HistoryLayout
@attribute [Authorize]

<PageTitle>
    @L["Shared_InventoryStore"]
</PageTitle>

<EduContainer Class="py-3 py-sm-6" MaxWidth="EduWidth.W1920">
    <EduPageHeader Title="@L["Shared_InventoryStore"]"/>
</EduContainer>

<EduContainer Class="pb-3 pb-sm-6" MaxWidth="EduWidth.W1920">
    <ProductToolbar @bind-Filter="@_filter" Wallet="@_wallet"/>
</EduContainer>

@if (_error is not null)
{
    <EduError Error="@_error"/>
}
else if (_isLoading)
{
    <Spinner/>
}
else
{
    <EduContainer Class="pb-3 pb-sm-6" MaxWidth="EduWidth.W1920">
        <ProductsGrid Products="@_source" Filter="@_filter" Context="product">
            <ProductCard
                Product="@product.Product"
                ShowLockBadge="@(!product.IsAffordable)"
                OnPurchaseClick="@OpenPurchaseDialog"/>
        </ProductsGrid>
    </EduContainer>
}

@code {
    private bool _isLoading = true;
    private Error? _error;
    private InventoryModel? _wallet;
    private ProductsFilter _filter = ProductsFilter.Empty;
    private IQueryable<ProductDto> _source = Enumerable.Empty<ProductDto>().AsQueryable();

    [Inject]
    private IStringLocalizer<App> L { get; set; } = default!;

    [Inject]
    private IHistoryStoreService StoreService { get; set; } = default!;

    [Inject]
    private IHistoryUserService UserService { get; set; } = default!;

    [Inject]
    private IDialogService DialogService { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        (await UserService.GetInventoryAsync())
            .Match(x => _wallet = x, x => _error = x);

        if (_error is not null)
            return;

        _source = (await StoreService.GetAsync())
            .Match(
                m => m.Select(x => new ProductDto(x, IsAffordable(_wallet, x))),
                x =>
                {
                    _error = x;
                    return Enumerable.Empty<ProductDto>();
                },
                Enumerable.Empty<ProductDto>
            )
            .AsQueryable();

        _isLoading = false;
    }

    private async Task OpenPurchaseDialog(ProductModel product)
    {
        if (_wallet is null)
            return;

        var options = new DialogOptions
        {
            FullWidth = true,
            MaxWidth = product.Inventories.Length > 3 ? MaxWidth.Medium : MaxWidth.Small,
            CloseButton = false,
            NoHeader = true
        };

        var parameters = new DialogParameters
        {
            [nameof(ProductDialog.Product)] = product,
            [nameof(ProductDialog.Wallet)] = _wallet
        };

        var dialog = await DialogService.ShowAsync<ProductDialog>(product.Title, parameters, options);
        var result = await dialog.Result;
        if (result.Canceled)
            return;

        await OnInitializedAsync();
    }

    private static bool IsAffordable(InventoryModel? wallet, ProductModel product)
    {
        if (wallet is null)
            return false;

        if (product.InventoryWeight > wallet.Backpack.Emptiness)
            return false;

        if (wallet.Wallet.TryGetValue(product.Selling.Total.Currency, out var amount))
            return amount >= product.Selling.Total.Amount;

        return false;
    }

}