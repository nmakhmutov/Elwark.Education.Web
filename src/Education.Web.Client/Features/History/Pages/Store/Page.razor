@page "/history/store"
@using Education.Web.Client.Features.History.Services.User.Model

@layout HistoryLayout
@attribute [Authorize]

<PageTitle>
    @L["InventoryStore_Title"]
</PageTitle>

<EduContainer Class="py-3 py-sm-6" MaxWidth="EduWidth.W1920">
    <EduPageHeader Title="@L["InventoryStore_Title"]"/>
</EduContainer>

<EduContainer Class="pb-3 pb-sm-6" MaxWidth="EduWidth.W1920">
    <ProductsToolbar @bind-Filter="@(_filter)" Possessions="@_possessions"/>
</EduContainer>

@switch (_filter.Catalog)
{
    case CatalogType.Inventory:
        <InventoryProducts
            Possessions="@_possessions"
            Filter="@_filter"
            IsAffordable="@IsInventoryAffordable"
            OnProductPurchased="@OnInventoryPurchased"/>
        break;

    case CatalogType.Bundles:
        <BundleProducts
            Possessions="@_possessions"
            Filter="@_filter"
            IsAffordable="@IsBundleAffordable"
            OnProductPurchased="@OnBundlePurchased"/>
        break;
}

@code {
    private ProductsFilter _filter = ProductsFilter.Empty;
    private PossessionsModel _possessions = new(new Dictionary<InternalCurrency, long>(), new PossessionsModel.BackpackModel(0, 0, 0));

    [Inject]
    private IStringLocalizer<App> L { get; set; } = default!;

    [Inject]
    private IHistoryUserService UserService { get; set; } = default!;

    protected override Task OnInitializedAsync() =>
        LoadInventoryAsync();

    private async Task LoadInventoryAsync() =>
        _possessions = (await UserService.GetPossessionsAsync())
            .Map(x => x)
            .UnwrapOr(_possessions);

    private Task OnInventoryPurchased() =>
        LoadInventoryAsync();

    private Task OnBundlePurchased() =>
        LoadInventoryAsync();

    private bool IsInventoryAffordable(Product.InventoryModel inventory) =>
        IsAffordable(inventory.Selling, inventory.Weight);

    private bool IsBundleAffordable(Product.BundleModel bundle) =>
        IsAffordable(bundle.Price, bundle.Weight);

    private bool IsAffordable(Product.PriceModel price, uint weight)
    {
        if (weight > _possessions.Backpack.Emptiness)
            return false;

        if (_possessions.Wallet.TryGetValue(price.Total.Currency, out var amount))
            return amount >= price.Total.Amount;

        return false;
    }

}